<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Search Friends</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; }
    .header { background:#2575fc; color:#fff; padding:1rem; text-align:center; font-size:1.2rem; }
    .container { padding:1rem; max-width:720px; margin:0 auto; }
    input { width:100%; padding:.7rem; border-radius:8px; border:1px solid #ccc; margin-bottom:1rem; }
    .card { background:#fff; padding:1rem; border-radius:10px; margin:.5rem 0; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    button { padding:.5rem 1rem; border:none; border-radius:6px; cursor:pointer; }
    .btn-add { background:#2575fc; color:#fff; }
    .btn-accept { background:#28a745; color:#fff; margin-right:6px; }
    .btn-reject { background:#dc3545; color:#fff; }
    .muted { color:#666; font-size:.9rem; }
  </style>
</head>
<body>
  <div class="header">Search Friends</div>
  <div class="container">
    <input type="text" id="searchEmail" placeholder="Type email (exact) or name/partial..."/>
    <div id="resultBox"></div>

    <h3>Friend Requests</h3>
    <div id="requestsBox" class="muted">Loading...</div>

    <h3>Friends</h3>
    <div id="friendsBox" class="muted">Loading...</div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getDatabase, ref, get, onValue, set, remove
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCQXgRvpR285OV_HmBRgbBmcNNCcfyfDWI",
      authDomain: "chattingbot0916.firebaseapp.com",
      projectId: "chattingbot0916",
      storageBucket: "chattingbot0916.firebasestorage.app",
      messagingSenderId: "955856103094",
      appId: "1:955856103094:web:349c85927913b0fc4fa817",
      databaseURL: "https://chattingbot0916-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const searchEmail = document.getElementById("searchEmail");
    const resultBox = document.getElementById("resultBox");
    const requestsBox = document.getElementById("requestsBox");
    const friendsBox = document.getElementById("friendsBox");

    let currentUser = null;

    const normalizeEmailKey = (email) =>
      (email || "").toLowerCase().replace(/[.#$\[\]]/g, "_").trim();

    onAuthStateChanged(auth, (user) => {
      if (!user) { window.location.href = "index1.html"; return; }
      currentUser = user;
      loadRequests();
      loadFriends();
    });

    // 🔎 Search handler
    searchEmail.addEventListener("input", async () => {
      const queryRaw = searchEmail.value.trim();
      if (!queryRaw) { resultBox.innerHTML = ""; return; }

      const q = queryRaw.toLowerCase();
      // 1) Exact email via index
      if (q.includes("@") && q.includes(".")) {
        const emailKey = normalizeEmailKey(q);
        const uidSnap = await get(ref(db, `emails/${emailKey}`));
        if (uidSnap.exists()) {
          const uid = uidSnap.val();
          if (uid === currentUser.uid) { resultBox.innerHTML = `<div class="card">That's you 😊</div>`; return; }
          const profSnap = await get(ref(db, `matrixData/${uid}/profile`));
          if (profSnap.exists()) {
            const p = profSnap.val();
            resultBox.innerHTML = `
              <div class="card">
                <p><b>${p.name || "(no name)"}</b><br>${p.email || q}</p>
                <button class="btn-add" onclick="sendRequest('${uid}')">Add</button>
              </div>`;
            return;
          }
        }
      }

      // 2) Fallback partial search (name/email contains)
      const allSnap = await get(ref(db, "matrixData"));
      if (!allSnap.exists()) { resultBox.innerHTML = `<div class="card">No users.</div>`; return; }

      const items = [];
      allSnap.forEach(child => {
        const uid = child.key;
        if (uid === currentUser.uid) return;
        const p = child.child("profile").val();
        if (!p) return;
        const name = (p.name || "").toLowerCase();
        const email = (p.email || "").toLowerCase();
        if (name.includes(q) || email.includes(q)) items.push({ uid, p });
      });

      if (items.length) {
        resultBox.innerHTML = items.map(({uid, p}) => `
          <div class="card">
            <p><b>${p.name || "(no name)"}</b><br>${p.email || ""}</p>
            <button class="btn-add" onclick="sendRequest('${uid}')">Add</button>
          </div>
        `).join("");
      } else {
        resultBox.innerHTML = `<div class="card">No user found.</div>`;
      }
    });

    // 📩 Send request
    window.sendRequest = async (toUid) => {
      if (!currentUser) return;
      await set(ref(db, `matrixData/${toUid}/requests/${currentUser.uid}`), { from: currentUser.uid, ts: Date.now() });
      alert("Request sent!");
    };

    // 📥 Load requests (show name+email)
    function loadRequests() {
      onValue(ref(db, `matrixData/${currentUser.uid}/requests`), async (snap) => {
        requestsBox.innerHTML = "";
        if (!snap.exists()) { requestsBox.innerHTML = `<div class="muted">No requests.</div>`; return; }

        const reqs = [];
        for (const child of Object.values(snap.val())) {
          reqs.push(child.from);
        }

        for (const fromUid of Object.keys(snap.val())) {
          const prof = await get(ref(db, `matrixData/${fromUid}/profile`));
          const p = prof.val() || {};
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <p><b>${p.name || fromUid}</b><br>${p.email || ""}</p>
            <button class="btn-accept" onclick="acceptRequest('${fromUid}')">Accept</button>
            <button class="btn-reject" onclick="rejectRequest('${fromUid}')">Reject</button>
          `;
          requestsBox.appendChild(card);
        }
      });
    }

    // ✅ Accept / ❌ Reject
    window.acceptRequest = async (fromUid) => {
      await set(ref(db, `matrixData/${currentUser.uid}/friends/${fromUid}`), true);
      await set(ref(db, `matrixData/${fromUid}/friends/${currentUser.uid}`), true);
      await remove(ref(db, `matrixData/${currentUser.uid}/requests/${fromUid}`));
    };

    window.rejectRequest = async (fromUid) => {
      await remove(ref(db, `matrixData/${currentUser.uid}/requests/${fromUid}`));
    };

    // 👥 Friends list
    function loadFriends() {
      onValue(ref(db, `matrixData/${currentUser.uid}/friends`), async (snap) => {
        friendsBox.innerHTML = "";
        if (!snap.exists()) { friendsBox.innerHTML = `<div class="muted">No friends yet.</div>`; return; }

        const friends = Object.keys(snap.val());
        for (const fid of friends) {
          const prof = await get(ref(db, `matrixData/${fid}/profile`));
          const p = prof.val() || {};
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <p><b>${p.name || fid}</b><br>${p.email || ""}</p>
            <button onclick="chatWith('${fid}')">Chat</button>
          `;
          friendsBox.appendChild(card);
        }
      });
    }

    // 🚀 Open chat
    window.chatWith = (fid) => {
      localStorage.setItem("chatFriend", fid);
      window.location.href = "chat.html";
    };
  </script>
</body>
</html>
