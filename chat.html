<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - chatbot0916</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; }
    .header { background: #2575fc; color: white; padding: 1rem; text-align: center; font-size: 1.2rem; }
    .messages { flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; }
    .msg { max-width: 70%; padding: 0.6rem 1rem; border-radius: 10px; margin: 0.3rem 0; position: relative; }
    .me { background: #2575fc; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
    .them { background: #fff; color: black; align-self: flex-start; border-bottom-left-radius: 0; }
    .replyPreview { font-size: 0.8rem; opacity: 0.8; margin-bottom: 3px; border-left: 3px solid #666; padding-left: 5px; }
    .inputContainer { display: flex; flex-direction: column; background: white; border-top: 1px solid #ddd; }
    .replyBox { display: none; background: #eee; padding: 5px; font-size: 0.9rem; border-left: 3px solid #2575fc; margin: 3px; }
    .replyBox span { font-weight: bold; }
    .inputBox { display: flex; padding: 0.8rem; align-items: center; }
    .inputBox input { flex: 1; padding: 0.7rem; border: 1px solid #ccc; border-radius: 8px; }
    .inputBox button { margin-left: 0.5rem; padding: 0.7rem 1.2rem; border: none; border-radius: 8px; background: #2575fc; color: white; cursor: pointer; }
    #friendActiveEmoji { display: none; font-size: 1.5rem; margin-right: 5px; animation: pulse 1.2s infinite; }
    #typingIndicator { display: none; font-size: 0.9rem; color: gray; padding: 3px 10px; }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.7; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 0.7; }
    }
    .timestamp { font-size: 0.7rem; opacity: 0.6; margin-top: 2px; }
  </style>
</head>
<body>
  <div class="header" id="chatHeader">Chat</div>
  <div class="messages" id="messages"></div>

  <div id="typingIndicator">‚úçÔ∏è Friend is typing...</div>

  <div class="inputContainer">
    <div class="replyBox" id="replyBox">
      Replying to: <span id="replyText"></span>
      <button onclick="clearReply()" style="float:right; background:none; border:none; cursor:pointer; color:red;">‚úñ</button>
    </div>
    <div class="inputBox">
      <div id="friendActiveEmoji">üëã</div>
      <input type="text" id="msgInput" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, push, set, onChildAdded, serverTimestamp, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    // ‚úÖ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCQXgRvpR285OV_HmBRgbBmcNNCcfyfDWI",
      authDomain: "chattingbot0916.firebaseapp.com",
      projectId: "chattingbot0916",
      storageBucket: "chattingbot0916.firebasestorage.app",
      messagingSenderId: "955856103094",
      appId: "1:955856103094:web:349c85927913b0fc4fa817",
      databaseURL: "https://chattingbot0916-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatHeader = document.getElementById("chatHeader");
    const replyBox = document.getElementById("replyBox");
    const replyText = document.getElementById("replyText");
    const friendActiveEmoji = document.getElementById("friendActiveEmoji");
    const typingIndicator = document.getElementById("typingIndicator");

    let currentUser = null;
    let friendId = localStorage.getItem("chatFriend");
    let chatRef;
    let replyTarget = null;
    let chatId;

    if (!friendId) {
      alert("‚ö†Ô∏è No friend selected!");
      window.location.href = "search.html";
    }

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "index1.html";
        return;
      }
      currentUser = user;
      startChat();
    });

    function startChat() {
      chatHeader.textContent = "Chat with " + friendId.substring(0,6) + "...";

      chatId = currentUser.uid < friendId 
                ? currentUser.uid + "_" + friendId 
                : friendId + "_" + currentUser.uid;

      chatRef = ref(db, "chats/" + chatId);

      // ‚úÖ Track my presence
      const myPresenceRef = ref(db, "presence/" + chatId + "/" + currentUser.uid);
      set(myPresenceRef, { active: true });
      onDisconnect(myPresenceRef).remove();

      // ‚úÖ Show friend's presence
      const friendPresenceRef = ref(db, "presence/" + chatId + "/" + friendId);
      onValue(friendPresenceRef, (snap) => {
        if (snap.exists() && snap.val().active) {
          friendActiveEmoji.style.display = "block";
        } else {
          friendActiveEmoji.style.display = "none";
        }
      });

      // ‚úÖ Typing indicator
      const typingRef = ref(db, "typing/" + chatId + "/" + currentUser.uid);
      const friendTypingRef = ref(db, "typing/" + chatId + "/" + friendId);

      msgInput.addEventListener("input", () => {
        set(typingRef, { isTyping: true });
        clearTimeout(msgInput._typingTimeout);
        msgInput._typingTimeout = setTimeout(() => {
          set(typingRef, { isTyping: false });
        }, 1500);
      });

      onValue(friendTypingRef, (snap) => {
        if (snap.exists() && snap.val().isTyping) {
          typingIndicator.style.display = "block";
          friendActiveEmoji.style.display = "none"; // hide wave when typing
        } else {
          typingIndicator.style.display = "none";
        }
      });

      // ‚úÖ Listen for new messages
      onChildAdded(chatRef, (snap) => {
        const msg = snap.val();
        const div = document.createElement("div");
        div.className = "msg " + (msg.from === currentUser.uid ? "me" : "them");
        div.draggable = true;
        div.ondragstart = () => setReply(msg.text);

        // Reply preview
        if (msg.replyTo) {
          const preview = document.createElement("div");
          preview.className = "replyPreview";
          preview.textContent = "‚Ü™ " + msg.replyTo;
          div.appendChild(preview);
        }

        // Message text
        const textNode = document.createElement("div");
        textNode.textContent = msg.text;
        div.appendChild(textNode);

        // Timestamp
        if (msg.timestamp) {
          const timeNode = document.createElement("div");
          timeNode.className = "timestamp";
          timeNode.textContent = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
          div.appendChild(timeNode);
        }

        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });

      // ‚úÖ Send message
      sendBtn.onclick = sendMessage;
      msgInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    async function sendMessage() {
      const text = msgInput.value.trim();
      if (!text) return;

      const newMsgRef = push(chatRef);
      await set(newMsgRef, {
        from: currentUser.uid,
        to: friendId,
        text: text,
        replyTo: replyTarget,
        timestamp: Date.now()
      });

      msgInput.value = "";
      clearReply();
    }

    function setReply(text) {
      replyTarget = text;
      replyBox.style.display = "block";
      replyText.textContent = text;
    }

    window.clearReply = function() {
      replyTarget = null;
      replyBox.style.display = "none";
      replyText.textContent = "";
    }
  </script>
</body>
</html>
